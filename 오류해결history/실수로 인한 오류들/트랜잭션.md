| ì°¸ê³  : ìŠ¤í”„ë§ > AOPì™€ íŠ¸ëœì­ì…˜
- ì½”ë“œ
```java
@Async
@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
public void sendMail(MemberCreatedMessage event) {

    MimeMessage mimeMessage = javaMailSender.createMimeMessage();

    try{
        makeEmailForm(event, mimeMessage);
        javaMailSender.send(mimeMessage);

    } catch (MessagingException e){
        log.error("error");
        rollbackRegistration(event);
        throw EmailException.wrongEmail();
    }
    log.info("Success");

}
```
### ë¬¸ì œìƒí™©
- ì´ë©”ì¼ í˜•ì‹ì— ì–´ê¸‹ë‚˜ê²Œ ìš”ì²­ì´ ë“¤ì–´ì˜¬ ë•Œ ë¡¤ë°±(íšŒì›ê°€ì… ì·¨ì†Œ)í•˜ë„ë¡ ì˜ë„í–ˆìœ¼ë‚˜, ì•„ë˜ì²˜ëŸ¼ ëª¨ë‘ ì´ìƒí•˜ê²Œ ì‘ë™í•¨
    - ì˜ëª»ëœ ì´ë©”ì¼ í˜•ì‹
        - emailgmailcom
        - ""
1. Asyncìˆì„ ë•Œ
    - ë©”ì¼ì£¼ì†Œë¥¼ emailgmailcomë¡œ ì§„í–‰
        - íšŒì›ê°€ì… ì •ìƒì ìœ¼ë¡œ ì§„í–‰(member ìƒì„±) ğŸ‘€
        - ì—ëŸ¬ ë°œìƒ
            ```
            MailSendException: Failed messages: javax.mail.SendFailedException: Invalid Addresses; 

            com.sun.mail.smtp.SMTPAddressFailedException: 553-5.1.3 The recipient address <aotolove2gmailcom> is not a valid RFC-5321
            ```
    - ë©”ì¼ì£¼ì†Œë¥¼ â€œâ€ë¡œ ì§„í–‰
        - ì˜ë„ì ìœ¼ë¡œ ë‹¤ ì‘ë™í•¨âœ… => ì™œ..?Asyncê°€ ìˆëŠ”ë° ë¡¤ë°±ì´..?
2. Asyncì—†ì„ ë•Œ
    - ë©”ì¼ì£¼ì†Œë¥¼ emailgmailcomë¡œ ì§„í–‰
        - íšŒì›ê°€ì… ë¬¸ì œì—†ì´ ì§„í–‰ë¨  ğŸ‘€
    - ë©”ì¼ì£¼ì†Œë¥¼ â€œâ€ë¡œ ì§„í–‰
        - javax.mail.internet.AddressException: Illegal address in string ``'' ì—ëŸ¬ ë°œìƒ
            - detailMessage : Illegal address
        - `rollbackRegistration` ë©”ì„œë“œê°€ ì œëŒ€ë¡œ ì‘ë™ì•ˆí•¨ ğŸ‘€
            - íšŒì›ê°€ì…ì´ ì§„í–‰ë¨..
            - ë””ë²„ê·¸ë¡œ ì•„ë˜ ì½”ë“œê¹Œì§€ ì˜¤ëŠ” ê²ƒ í™•ì¸. ì™œ ì‘ë™ì„ ì•ˆí•˜ì§€?
            ```
            memberRepository.deleteById(event.getId());
            throw BusinessLogicException.sendingEmailException(event.getId());
            ```
### 1ì°¨ ìˆ˜ì •
- @TransactionalEventListenerë¥¼ @EventListenerë¡œ ë³€ê²½
1. Asyncìˆì„ ë•Œ
    - ë©”ì¼ì£¼ì†Œë¥¼ emailgmailcomë¡œ ì§„í–‰
        - íšŒì›ê°€ì… ì •ìƒì ìœ¼ë¡œ ì§„í–‰(member ìƒì„±) => @Async ë•Œë¬¸
        - ì—ëŸ¬ ë°œìƒ
            ```
            SimpleAsyncUncaughtExceptionHandler : Unexpected exception occurred invoking async method: public void board.common.event.email.listener.MemberEventListener.sendMail(board.common.event.MemberCreatedMessage) 

            org.springframework.mail.MailSendException: Failed messages: javax.mail.SendFailedException: Invalid Addresses;
            nested exception is:
                com.sun.mail.smtp.SMTPAddressFailedException: 553-5.1.3 The recipient address <aotolove2gmailcom> is not a valid RFC-5321
            ```
    - ë©”ì¼ì£¼ì†Œë¥¼ â€œâ€ë¡œ 
        - íšŒì›ê°€ì… ì •ìƒì ìœ¼ë¡œ ì§„í–‰(member ìƒì„±) => @Async ë•Œë¬¸
        - ì—ëŸ¬ ë°œìƒ
            ```
            SimpleAsyncUncaughtExceptionHandler : Unexpected exception occurred invoking async method: public void board.common.event.email.listener.MemberEventListener.sendMail(board.common.event.MemberCreatedMessage) 

            org.springframework.dao.EmptyResultDataAccessException: No class board.member.Member entity with id 1 exists!
            ```
2. Asyncì—†ì„ ë•Œ
    - ë©”ì¼ì£¼ì†Œë¥¼ emailgmailcomë¡œ ì§„í–‰
        - 500ì—ëŸ¬ 
            - íšŒì›ê°€ì…ì€ ì •ìƒì ìœ¼ë¡œ ë¡¤ë°±ë¨.
            - ì—ëŸ¬ì²˜ë¦¬ ì •ìƒì ìœ¼ë¡œ ì•ˆë¨
        - MailSendException ì—ëŸ¬ë¡œ ì—ëŸ¬ì²˜ë¦¬ë¥¼ í•˜ë©´ ì˜ë„í•œëŒ€ë¡œ ì—ëŸ¬ë¡œê·¸ ì°íˆì§€ë§Œ, ë¡¤ë°± ë‹¨ê³„ì˜ BusinessLogicExceptionì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ”ë°, ì²˜ë¦¬í•œ ì—ëŸ¬ì¸ë° ì™œ ìŠ¤íƒíŠ¸ë ˆì´ìŠ¤ê°€ ì°íˆì§€?

    - ë©”ì¼ì£¼ì†Œë¥¼ â€œâ€ë¡œ ì§„í–‰
        - ìƒë™
### MailSendException vs MessagingException
- ì™œ MessagingExceptionê°€ ì•„ë‹ˆë¼ MailSendExceptionë¡œ ì—ëŸ¬ì²˜ë¦¬ê°€ ë˜ì§€?