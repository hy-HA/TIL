[참고- IAM 사용자 계정](https://m.blog.naver.com/dsz08082/222387462598)

# IAM 사용자 계정 개념과 관리

## IAM 이란
- 이메일 아이디로 만든 AWS 계정을 루트 계정으로 부른다. 
- 루트 계정은 제일 처음 AWS를 통해 만든 계정으로서 모든 AWS 자원에 접근할 수 있는 권한을 가지고 있기 때문에 여러 명의 사용자가 루트 계정을 사용하는 것은 보안에 좋지 않다.
- 때문에 AWS에서는 IAM(Identity and Access Management) 서비스를 제공한다. 
- IAM은 누가 자원에 접근하는지에 대한 자격증명과 무엇을 어디까지 허용할 지에 대한 권한을 가진다. 
- 이 IAM은 루트 계정을 사용하지 않고 각 사용자들이 AWS 자원에 접근할 수 있도록 해준다. 
- 또, IAM을 통해 유저, 유저 그룹을 만들어 각 사용자 혹 그룹 별 필요한 권한만 제한적으로 부여할 수 있다. 
- AWS의 모든 서비스는 IAM을 활용해 AWS 자원을 사용하도록 로그인을 설정하고 권한이 부여된 대상을 제어한다.

## IAM의 특징과 구성
- 특징
    - 각 AWS 서비스 및 자원 별 사용 권한 지정
    - 역할 및 정책으로 용이한 권한 관리
    - 기업 내 사용자 관리 시스템과 연동 지원
    - 오프라인 기기를 통한 인증
- 구성
- IAM은 크게 사용자를 정의하는 IAM 사용자/그룹/역할과 각 사용자의 권한을 정의하는 IAM 정책으로 구성된다.
1. IAM 사용자
    - 루트 사용자 : 모든 접근 권한을 가지는 가장 중요한 사용자, 특정 그룹에 속하지 않고 사용자를 만들 수 있는 권한이 있으며 아이디와 비밀번호로 AWS 콘솔에 접속할 수 있다.
    - 일반 사용자 : 루트 사용자와 유사하지만 부여된 정책에 한해서만 자원에 접근될 수 있다는 점이 다르다.
    - 그룹 : 사용자 관리를 편하게 하는 기능이다. 그룹에 정책을 정의하면 그룹원 모두가 영향을 받는다.
    - 역할 : 사용자와 유사하지만 비밀번호를 통해 접속할 수 없고 그룹에 속할 수도 없다. 정책에 한해서 자원에 접근할 수 있고 정책이 부여되지 않으면 아무것도 할 수 없다.
    - 정책 : AWS 자원에 접근하기 위해 권한을 허용할 지 거부할 지를 결정한다. JSON 형태로 저장되며 각 그룹, 역할, 사용자에 부여할 수 있다.

# 배포
[참고 1](https://bcp0109.tistory.com/356)
[참고 2](https://lucas-owner.tistory.com/44)
- 보안그룹 설정
- EC2 인스턴스 생성
- 고정주소(탄력적IP)설정
- SSH 클라이언트로 EC2 접속
- 자바 설치
- 스프링부트 실행

## 보안그룹 설정
- 보안 그룹은 AWS 에서 제공하는 방화벽 
- AWS 에서 사용할 수 있는 방화벽 설정 개념
- EC2의 경우 SSH의 접속을 허용 한다던가, 
- RDS의 경우 Local, EC2에서만 접근이 가능하다던지의 개념
- 서비스를 제공하는 애플리케이션이라면 상관 없지만 RDS 처럼 외부에서 함부로 접근하면 안되는 인스턴스는 허용된 IP 에서만 접근하도록 설정이 필요
    - 인바운드 (Inbound): 외부 -> EC2 인스턴스 내부로 접속 허용
    - 아웃바운드 (Outbound): EC2 인스턴스 내부 -> 외부 허용
        - EC2의 경우 특별한 경우에만 따로 설정

1. 현재 보안 그룹 확인
    - 인스턴스 정보의 보안 탭에서 현재 설정된 보안 그룹을 확인할 수 있습니다.
    - 처음 인스턴스를 생성할 때 아무런 보안 그룹을 설정하지 않았기 때문에 default 값만 들어가있습니다.
    - 인바운드 규칙 해석해보면 22번 포트의 모든 IP 에 대해서 TCP 연결을 허용한다는 의미입니다.
    - SSH 접속을 위해 22번 포트는 기본으로 설정해준 것 같네요.
    - 이제 새로운 보안 그룹을 만들어 봅시다.
2. 보안 그룹 ID 리스트 확인
    - 인스턴스에서 보안 그룹 ID 를 보고 들어갈 수도 있지만 메뉴에서 직접 들어가면 이렇게 보안 그룹 ID 리스트를 볼 수 있습니다.
    - 보안 그룹은 인스턴스와 별개로 존재하기 때문에 한번 만들어두면 새 인스턴스를 생성해도 한번에 적용할 수 있습니다.
    - 우측 상단의 "보안 그룹 생성" 버튼을 눌러서 새 보안 그룹을 만들어봅시다.
3. 보안 그룹 생성 및 설정
    - 보안 그룹의 이름과 설명을 추가하고 인바운드 규칙과 아웃바운드 규칙을 편집
    1. 보안 그룹 생성
        - AWS / EC2 Management console / 네트워크 및 보안 / 보안 그룹 으로 이동. 
    2. 보안 그룹 상세 설정 
        - 이름, 설명, 아웃바운드
4. 인바운드 설정
    - 인바운드의 경우, 외부에서 접근을 허용하는것 이기 때문에 상세 설정이 필요 
    - 기본적으로 허용할 IP의 카테고리들이 존재하며, Server port 같은것들은 사용자 지정으로 추가 해줘야 한다. 
    - 만약 협업을 해야 한다면, SSH 유형을 추가하고 팀원들의 IP와 port(22)를 추가해줘야 한다. 
    - SSH 접속을 위한 (SSH), HTTP, HTTPS, Spring Boot 서버 port를 기본적으로 추가 해준다. 
5. 아웃바운드 설정
6. 인스턴스에서 보안 그룹 변경
7. 변경된 보안 그룹 확인

## 인스턴스 생성
- EC2 (Elastic Compute Cloud)
    - 사용자가 원하는 애플리케이션을 실행할 수 있는 가상의 컴퓨터를 임대해 주는 서비스라고 이해하면 됩니다.
1. 계정 생성 후 콘솔에 로그인
2. AWS Region 설정
    - 리전에 따라 인스턴스 위치가 결정
    - 외국으로 하면 속도가 낮을 수 있음
3. EC2 메뉴로 이동
    - AWS 관리 콘솔에서 가상 머신 시작을 누릅니다. 
    - 이 기능을 통해 AWS의 호스팅 서비스인 EC2(Elastic Compute Cloud)를 이용할 수 있습니다.
    - EC2는 사용자가 원하는 애플리케이션을 실행할 수 있는 가상의 컴퓨터를 임대해 주는 서비스라고 이해하면 됩니다.
4. 새 인스턴스 생성
    - 인스턴스 메뉴로 들어가 인스턴스 시작 버튼 클릭
5. Amazon Machine Image(AMI) 및 인스턴스 유형 선택
    - 이름 
        - 생략 가능하나 EC2 를 쉽게 식별하기위해 지정
    - AMI : 어떤 서버로 구성할지 선택
        - 원하는걸 선택. 포스트 예시) 프리티어의 Ubuntu STS버전
    - 인스턴스 유형
        - 프리티어를 선택했다면 인스턴스 유형은 자동으로 결정됨
        - 인스턴스 유형은 반드시 t2.micro로 해야 합니다. 그 외에 유형을 선택하면 요금이 발생할 수 있습니다. 
        - 스펙이 좋을 수록 과금이 더 많이 되기 때문에 작게 시작했다가 스케일업하는걸 추천
    - 인스턴스 세부 정보 구성은 모두 기본 값으로 설정하고 넘어가도 됩니다. 다음 버튼을 눌러 줍니다.
6. 키 페어 생성
    1. 사전에 키페어를 만들었다면
        - 사전에 만들어둔 키페어 선택
    2. 사전에 키페어를 안 만든경우
        - 키 페어는 EC2 서버에 SSH 접숙을 하기 위해 필수
        - "새 키 페어 생성"을 눌러 원하는 이름을 적고 생성
            - 자동으로 my-key.pem 파일이 다운됨
        - SSH 환경에 접속하기 위해서는 해당 키 파일이 존재하는 위치로 가서 ssh 명령어를 실행
        - 한번 다운받은 후에는 재다운 받을 수 없기 때문에 안전한 곳에 저장
        - 생성한 후에는 키 페어(로그인)에서 키 페어를 선택
7. 네트워크 및 스토리지 선택
    - 네트워크 설정은 EC2 에 접속을 허용하는 ACL 을 생각하면 됩니다.
    1. 보안그룹을 사전에 설정한 경우
        - 사전에 설정한 보안그룹 선택
    2. 나중에 설정할 경우
        - 나중에 "보안 그룹" 이라는 걸로 별도 설정을 할 예정이기 때문에 SSH 트래픽만 허용해줍니다.
        - 위 설정대로 하면 SSH 트래픽 접속 가능한 IP 가 내 IP 로 자동 설정 됩니다.
        - 프리티어는 최대 30 까지 지원하기 때문에 해당 부분만 변경해줍니다.
            - 프리 티어를 사용할 경우 최대 30GB의 SSD 혹은 마그네틱 스토리지를 사용할 수 있습니다.
        - 볼륨 유형은 범용 SSD 로 선택해야 합니다.
        - 만약 Provisioned IOPS SSD (프로비저닝된 IOPS SSD) 를 선택한다면 사용하지 않아도 활성화한 기간만큼 계속 비용이 발생하게 됩니다.
    
8. 인스턴스 생성 완료
    - 처음 화면으로 돌아오면 인스턴스 생성된 것 확인 가능
    - 인스턴스 ID를 클릭하면 탄력적 IP와 보안그룹 추가할 수 있음

## 탄력적 IP(Elastic IP)
- AWS EC2 인스턴스는 서버를 중지하고 다시 실행시키면 퍼블릭 IP 가 변경되기 때문에 클라이언트가 사용할 수 있는 변하지 않는 IP 가 필요합니다.
- 탄력적 IP (Elastic IP) 란 외부에서 인스턴스에 접근 가능한 고정 IP 입니다.
    - 탄력적 IP 는 만들어놓고 사용하지 않더라도 과금이 되기 때문에 필요한 만큼만 생성하는 것이 중요합니다.
    - 자세한 설명은 AWS Docs - 탄력적 IP 에서 확인
- 우선, 진짜 퍼블릭 IP 가 변경하는지 한번 확인해봅시다.
- EC2 > 인스턴스 > 인스턴스 아이디에서 생성된 인스턴스의 정보 확인
    - 퍼블릭 IPv4 주소에 퍼블릭 IP 로 3.35.238.69 가 할당된 것을 확인할 수 있습니다.
- 인스턴스를 중지 시켰다가 다시 실행
    - 인스턴스 ID, 프라이빗 IP 와 같은 정보는 동일한데 퍼블릭 IP 가 13.125.3.218 로 변경된 것을 볼 수 있습니다.
- 이렇게 퍼블릭 IP 는 변경될 가능성이 있기 때문에 변하지 않는 탄력적 IP 를 할당해주어야 합니다.

1. 탄력적 IP 메뉴 접근
    - 메뉴에서 탄력적 IP 클릭
    - 아직 아무것도 할당받은게 없기 때문에 새로운 IP추가 필요
        - 탄력적 IP 주소 할당 버튼 클릭
2. 새로운 탄력적 IP 할당
    - 딱히 변경할 건 없고 바로 할당 클릭
3. 탄력적 IP주소 선택
    - 방금 생성한 탄력적 IP를 선택해서 연결 시도 
4. 인스턴스 선택 및 연결
    - 설정화면에 들어가면 현재 내 인스턴스 목록을 선택할 수 있고 
    - 연결된 프라이빗 IP까지 선택 가능
5. 인스턴스 정보 확인
    - 탄력적 IP를 연결하고 다시 인스턴스 정보를 확인해보면 IP가 할당된 것 볼 수 있음
    - 퍼블릭 IP주소도 기존 값에서 탄력적 IP주소로 자동으로 변경

## SSH 클라이언트 서버로 접속
- 내가 만든 EC2인스턴스에 접속해보자
- 인스턴스 정보에서 "연결"버튼을 클릭하면 인스턴스에 연결 가능한 여러가지 방법을 알려줍니다.
- 여기서 "SSH 클라이언트" 로 접속하는 방법을 알아봅니다.
    - 사실 너무 친절하게 알려주고 명령어도 복사할수 있게 되어있어서 따로 할건 없음
    - 저 방법대로 서버에 한번 접속해보고, 호스트를 등록해서 간편하게 등록하는 방법을 알아봅시다.

1. 터미널 실행 후 키 페어 파일 위치로 이동
    - 터미널을 실행해서 이전에 다운 받은 키 페어 파일 위치로 이동합니다.
    - 저는 다운로드 받은 후 따로 옮기지 않았기 때문에 Downloads 디렉토리에 들어갔습니다.
    - 키 파일이 없으면 접속할 수 없고 다시 다운받을 수도 없기 때문에 잘 관리해야 합니다.
2. 키 파일 권한 변경
    - 키 파일의 권한을 변경
    ```
    $ chmod 400 my-key.pem
    ```
    - chmod 뒤의 숫제 3개는 나/그룹/전체에 대한 권한을 의미
        - read(4), write(2), execute(1)의 조합으로 권한을 나타냄
        - 예) 5 : 4+1로 read, write 권한이 있음
        - 예) 400 : 나에게만 읽기 권한이 있음
3. SSH 접속
    - 가이드에 있는 대로 퍼블릭 DNS 또는 퍼블릭 IP 를 사용해서 인스턴스에 접속할 수 있습니다.
4. 호스트 등록해서 간편하게 접속
    - 이제 우리는 SSH 로 EC2 인스턴스 서버에 접속할 수 있습니다.
    - 하지만 위에서 본 것처럼 매번 ssh -i {키 페어 파일} {ubuntu}@{탄력적 IP} 를 입력해야 합니다.
    - 일일히 기억하기도 귀찮고 타이핑도 번거롭기 때문에 호스트로 등록해서 쉽게 접속할 수 있도록 변경해봅시다.
### 오류메시지
```
➜  Desktop git:(master) ✗ cd awsKey
➜  awsKey git:(master) ✗ ls board-key.pem 
board-key.pem
➜  awsKey git:(master) ✗ chmod 400 board-key.pem 
➜  awsKey git:(master) ✗ ssh -i "board-key.pem" ubuntu@ec2-52-79-147-126.ap-northeast-2.compute.amazonaws.com
The authenticity of host 'ec2-52-79-147-126.ap-northeast-2.compute.amazonaws.com (52.79.147.126)' can't be established.
ED25519 key fingerprint is SHA256:Y268BEPoYixc8Jj/MALHps7TbZejCSbSlVEIt9NSF54.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'ec2-52-79-147-126.ap-northeast-2.compute.amazonaws.com' (ED25519) to the list of known hosts.
ssh_dispatch_run_fatal: Connection to 52.79.147.126 port 22: Broken pipe
```
### 호스트로 등록
1. ~/.ssh 디렉터리로 키 페어 파일 복사
    - 우선 키 페어 파일을 ~/.ssh/ 로 복사합니다.
2. 키 페어 파일 권한 변경
    - 키 페어 파일의 권한을 변경합니다.
    ```
    $ chmod 600 my-key.pem
    ```
3. ~/.ssh/config 파일 생성
    - ~/.ssh/ 디렉터리에 config 파일을 생성해서 다음과 같이 입력
        - 이미 파일이 존재한다면 맨 아래에 입력하면 됩니다.
     - User 는 우분투를 선택했다면 ubuntu 고 그 외에는 전부 ec2-user 일겁니다.
    ```
    Host mykeyhost
    User ubuntu
    HostName {탄력적 IP}
    IdentityFile ~/.ssh/board-key.pem
    ```
    1. vi 명령어 실행 직후 i를 눌러 편집 모드로 변경
    2. 하단의 Host ~~~ 내용 입력 후 esc를 눌러 편집 모드 종료
    3. :wq 를 이용해 파일 저장 후 나가기
    - 이전에 설정한 적이 없다면 파일이 존재하지 않을 수 있다.
4. 설정한 Host 이름으로 접속
    - 이제 키 페어 파일이 없는 곳에서도 간단한 별칭으로 SSH 접속이 가능합니다.
    ```
    ssh mykeyhost
    ```
### host접속 오류
```
The authenticity of host '52.79.147.126 (52.79.147.126)' can't be established.
ED25519 key fingerprint is SHA256:Y268BEPoYixc8Jj/MALHps7TbZejCSbSlVEIt9NSF54.
This host key is known by the following other names/addresses:
    ~/.ssh/known_hosts:1: ec2-52-79-147-126.ap-northeast-2.compute.amazonaws.com
Are you sure you want to continue connecting (yes/no/[fingerprint])?  yes
Warning: Permanently added '52.79.147.126' (ED25519) to the list of known hosts.
Connection closed by 52.79.147.126 port 22
```
- 일단 yes함
- 참고(https://blueyikim.tistory.com/1792)
## EC2 인스턴스에 스프링부트 서버 띄우기 - 수동

### 빌드 파일 복사해서 수동으로 띄우기
[참고 1](https://bcp0109.tistory.com/356)

- 배포 시스템 이런거 생략하고 진짜 단순하게 서버 띄우는 것만 확인해봅니다.
- 가장 간단한 방법은 두가지가 있는데 1번으로 진행하겠습니다.
    1. jar 파일을 빌드하여 EC2 복사 후 실행
    2. EC2 에서 프로젝트 git clone 후 실행
1. JDK 설치
2. Spring Boot 프로젝트 빌드
    - 프로젝트를 빌드하면 ./build/libs 디렉토리에 jar 파일이 생성됩니다.
    - 해당 파일을 EC2 서버로 복사합니다.
    - 호스트 이름에는 ubuntu@{퍼블릭 IP} 또는 ubuntu@{퍼블릭 DNS} 가 들어가야 하는데 만약 ~/.ssh/config 에 호스트 이름을 등록해두었다면 간소화된 - 이름을 사용할 수 있습니다.
    - 퍼블릭 IP (탄력적 IP) 또는 퍼블릭 DNS 를 그대로 사용한다면 키 페어 파일 (.pem) 이 명령어를 사용하는 위치에 존재해야 합니다.
3. EC2 인스턴스에서 
    - nohup 명령어를 사용하면 로그를 nohup.out 파일에 남길 수 있습니다.
    ```
    nohup java -jar board-0.0.1-SNAPSHOT.jar &
    ```
    명령어 실행결과
    ```
    ➜  board git:(master) ✗ pwd
    /Users/heeha/Downloads/board
    ➜  board git:(master) ✗ scp ./build/libs/board-0.0.1-SNAPSHOT.jar mykeyhost:/home/ubuntu
    board-0.0.1-SNAPSHOT.jar                                                                         100%   47MB  11.0MB/s   00:04    
    ➜  board git:(master) ✗ nohup java -jar board-0.0.1-SNAPSHOT.jar &
    [1] 3936
    appending output to nohup.out                                                
    [1]  + 3936 exit 1     nohup java -jar board-0.0.1-SNAPSHOT.jar

    ```
4. 퍼블릭 IP 또는 DNS 로 접근 확인

### 배포시스템 구축 
[참고 - EC2에서 깃과 깃허브 사용하기](https://develop-writing.tistory.com/121)

1. EC2에서 ssh 공개키와 개인키 생성
2. 공개키, 개인키 생성
3. ssh Key Github에 등록
4. 프로젝트 clone
5. 코드들이 잘 수행되는지 테스트로 검증
6. 배포 스크립트 만들기