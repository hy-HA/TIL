
## λΌμ΄λΈλ¬λ¦¬ μ¶”κ°€
- μ¤ν”„λ§ μ›Ήμ΄ μ„¤μΉλμ–΄μμΌλ©΄ μλ™μΌλ΅ μ¶”κ°€λ¨

## @EnableAspectAutoProxy μ¶”κ°€
- @SpringBootApplication λλ” @Configurationμ„ μ‚¬μ©ν• ν΄λμ¤μ— @EnableAspectAutoProxyλ¥Ό μ¶”κ°€ν•λ©΄ Spring AOPλ¥Ό μ‚¬μ©μ΄ κ°€λ¥
    ```java
    @EnableAspectJAutoProxy
    @SpringBootApplication
    public class TestApplication {

        public static void main(String[] args) {
            SpringApplication.run(TestApplication.class, args);
        }
    }

    ```

## AOP κ΄€λ¦¬ν•  ν΄λμ¤μ— @Aspect μ μ©
- Aspect μ—­ν• μ„ ν•  ν΄λμ¤λ¥Ό μ„ μ–Έν•κΈ° μ„ν•΄ μ–΄λ…Έν…μ΄μ… μ„ μ–Έ
    - Adviceλ“¤ + Pointcutλ“¤
    - @Aspectκ°€ λ“±λ΅λ λΉμ—λ” μ–΄λ“λ°”μ΄μ¤(Advice)λΌ λ¶λ¦¬λ” λ©”μ„λ“λ¥Ό μ‘μ„± κ°€λ¥
    ```java
    @Aspect
    @Component
    public class RequestLoggingAspect {
    }
    ```
- @Aspect μ–΄λ…Έν…μ΄μ…μ„ μ μ©ν• ν΄λμ¤λ”  
    1. Aspect κµ¬ν„μ„ μ κ³µ
        - ν•΄λ‹Ή ν΄λμ¤μ λ©”μ„λ“λ” Aspectκ°€ μ κ³µν•  κ³µν†µ κΈ°λ¥μ κµ¬ν„μ— ν•΄λ‹Ή
    2. PointCutκ³Ό Adviceλ¥Ό μ„¤μ •
        - μ„ κ³µν†µ κΈ°λ¥μ„ μ–Έμ , μ–΄λ””μ— μ μ©ν• μ§€ μ—¬λ¶€λ” λ©”μ„λ“μ— λ¶™μ€ @Around μ–΄λ…Έν…μ΄μ…μ„ μ‚¬μ©ν•μ—¬ μ„¤μ •
        - @Aspectκ°€ λ“±λ΅λ λΉμ—λ” μ–΄λ“λ°”μ΄μ¤(Advice)λΌ λ¶λ¦¬λ” λ©”μ„λ“λ¥Ό μ‘μ„± κ°€λ¥
        - λ€μƒ μ¤ν”„λ§ λΉμ methodμ μ‹μ κ³Ό λ°©λ²•μ— λ”°λΌ @Before, @After, @AfterReturning, @AfterThrowing, @Around λ“±μ„ λ…μ‹
- μ΅°κ±΄
    - μ¤ν”„λ§ λΉμ— λ“±λ΅λ ν΄λμ¤μ— μ¶”κ°€
    - ν•΄λ‹Ή λΉμ΄ Aspectλ΅ μ‘λ™
- μ°Έκ³  
    - λΉ κ°„ μ‘λ™μμ„ μ μ© κ°€λ¥
        - ν΄λμ¤μ— @Orderλ¥Ό λ…μ‹ν•μ—¬ @Aspectλ΅ λ“±λ΅λ λΉ κ°„μ μ‘λ™ μμ„λ¥Ό μ •ν•  μ μμ
        - μμ„λ” int νƒ€μ…μ μ •μλ΅ μμ„λ¥Ό μ •ν•  μ μλ”λ° κ°’μ΄ λ‚®μ„μλ΅ μ°μ„ μμ„κ°€ λ†’μ.
        - μμ„μ κΈ°λ³Έκ°’μ€ κ°€μ¥ λ‚®μ€ μ°μ„ μμ„λ¥Ό κ°€μ§€λ” Ordered.LOWEST_PRECEDENCE
## PointCutκ³Ό Advice μ„¤μ •
1. Pointcut
    - μ΅°μΈ ν¬μΈνΈλ¥Ό κ²°μ • ?
    - μ–΄λ“λ°”μ΄μ¤κ°€ μ‹¤ν–‰λλ” μ‹κΈ°λ¥Ό μ μ–΄ ?
    - μ–΄λ–¤ λ©”μ„λ“λ¥Ό μ΅μ„μ§€ ?
    - μ–΄λ–¤ μ΅°κ±΄μ— μ–΄λ“λ°”μ΄μ¤λ¥Ό μ μ©ν•  κ²ƒμΈκ°€?
        - post, patch, put, delete λ“± 
    - μ†μ„±
        1. @within : ν΄λμ¤
        2. @annotation : λ©”μ†λ“
    - μμ‹ : PostMapping μ–΄λ…Έν…μ΄μ…μ΄ μ‚¬μ©λ λ©”μ„λ“μ— Advie μ μ©
        ```java
        //PostMapping μ–΄λ…Έν…μ΄μ… μ‚¬μ©λ λ©”μ„λ“
        @Pointcut("@annotation(org.springframework.web.bind.annotation.PostMapping)")
        protected void PostMapping(){}

        //RestController μ–΄λ…Έν…μ΄μ… μ‚¬μ©λ ν΄λμ¤
        @Pointcut("@within(org.springframework.web.bind.annotation.RestController)")
        protected void restController() {}
        ```
2. Advice
    - ν¬μΈνΈμ»·μ΄ μ΅μ€ ν΄λμ¤ or λ©”μ„λ“
    ```java
    @Around(value = "restController() && getMapping()")
    public Object endpoint(ProceedingJoinPoint joinPoint) { }
    ```

    1. @Before
        - λ€μƒ method μ‹¤ν–‰ "μ „"μ— μ›ν•λ” μ‘μ—…μ„ μ„¤μ •
        - ν¬μΈνΈμ»·κ³Ό ν•¨κ» 
            - μ–΄λ“λ°”μ΄μ¤μ parameterλ” PointCut ν‘ν„μ‹       
        - λΌμ–΄λ“¤ λ©”μ„λ“μ λ²”μ„λ¥Ό μ§€μ •
            - λΌμ–΄λ“¤κΈ°λ§ ν•  λΏ λ€μƒ λ©”μ„λ“μ μ μ–΄λ‚ κ°€κ³µμ€ λ¶κ°€λ¥ 
        - μ „λ‹¬ λ°›λ” JoinPoint μ¤λΈμ νΈλ” methodμ μ •λ³΄λ¥Ό λ‹΄κ³  μμ
        ```java
        @Before("execution(* com.example.*.*(..))")
        public void somethingBefore(JoinPoint joinPoint) {
        }
        ```
    2. @AfterReturning
        - ν•΄λ‹Ή methodμ μ‹¤ν–‰μ΄ "μΆ…λ£λμ–΄ κ°’μ„ λ¦¬ν„΄ν•  λ•"
            ```java
            @AfterReturning(pointcut = "execution(* com.example.*.*(..))", returning = "result")
            public void doSomethingAfterReturning(JoinPoint joinPoint, Object result) {
                // λ¦¬ν„΄ μ‹ μ‹¤ν–‰
            }
            ```

    3. @Around
    - @Around μ–΄λ“λ°”μ΄μ¤λ” @Before @After κΈ°λ¥μ„ λ¨λ‘ ν¬κ΄„
    - λ€μƒ methodλ¥Ό μ‹¤ν–‰ μ•/λ’¤ μ‹μ μ— μ›ν•λ” μ‘μ—… μ„¤μ • κ°€λ¥
        ```java
        // νΉμ • μ–΄λ…Έν…μ΄μ…μ΄ λ…μ‹λ λ¨λ“  λ©”μ„λ“ μ‹¤ν–‰ μ „ν›„λ΅ λΌμ–΄λ“¤ μ μλ‹¤.
        @Around("@annotation(sampleAnnotation)")
        public Object somethingAround(final ProceedingJoinPoint joinPoint, final SomeAnnotation someAnnotation) {

            // μ‹¤ν–‰ μ „
            Object result = joinPoint.proceed();
            // μ‹¤ν–‰ ν›„

            return result;
        }

        // νΉμ • μ–΄λ…Έν…μ΄μ…μ΄ λ…μ‹λ ν΄λμ¤μ λ¨λ“  method
        @Around("@within(org.springframework.web.bind.annotation.RestController) || @within(org.springframework.stereotype.Service) || @within(org.springframework.stereotype.Repository)")
        public Object process(final ProceedingJoinPoint joinPoint) throws Throwable {
        }
        ```
## AOP κ΄€λ¦¬ν•  ν΄λμ¤
1. μ΅°μΈν¬μΈνΈμ λ©”μ†λ“ μ¶”μ¶
2. λ©”μ†λ“μ μ¤νΌλ μ΄μ…κ³Ό getMappingμ–΄λ…Έν…μ΄μ… μ¶”μ¶
3. μ»¨νΈλ΅¤λ¬μ™€ λ©”μ†λ“μ μ΄λ¦„, λ°ν™ κ°’μ λ΅κ·Έ μ¶λ ¥
4. λ©”μ†λ“ μ‹¤ν–‰
```java
@Slf4j
@Aspect // 1. Aspect
@Component
public class RequestLoggingAspect {

    // 2. Advice    // 3. Ponitcut
    @Around(value = "restController() && getMapping()")
    public Object query(ProceedingJoinPoint joinPoint) {

        //(1)μ΅°μΈν¬μΈνΈμ λ©”μ†λ“ μ¶”μ¶
        MethodSignature signature = (MethodSignature) joinPoint.getSignature();
        Method method = signature.getMethod();

        //(2) λ΅κ·Έλ΅ μ¶λ ¥ν•  λ€μƒ(μ¤νΌλ μ΄μ…, getλ§¤ν•‘)
        Operation operation = method.getAnnotation(Operation.class);
        GetMapping getMapping = method.getAnnotation(GetMapping.class);

        Object result;

        //(3) μ»¨νΈλ΅¤λ¬μ™€ λ©”μ†λ“μ μ΄λ¦„, λ°ν™ κ°’μ λ΅κ·Έ μ¶λ ¥
        //(4) λ©”μ†λ“ μ‹¤ν–‰
        try {
            log.error(operation.summary());
            log.error(Arrays.toString(getMapping.value()));
            result = joinPoint.proceed();
        } catch (Throwable e) {
            throw new RuntimeException(e);
        }

        return result;
    }
        // 3. Pontcut
        @Pointcut("@annotation(org.springframework.web.bind.annotation.GetMapping)")
        protected void getMapping() {
        }

        @Pointcut("@within(org.springframework.web.bind.annotation.RestController)")
        protected void restController() {
        }
}
```
## λ©”μ„λ“μ— μ‚¬μ©λ κ°μ²΄λ“¤

### 1. μ΅°μΈν¬μΈνΈμ λ©”μ„λ“ μ¶”μ¶
1. MethodSignature
2. μ΅°μΈν¬μΈνΈ(ProceedingJoinPoint)
    - JoinPoint 
        - νΈμ¶λλ” κ°μ²΄μ— λ€ν• μ •λ³΄, μ‹¤ν–‰λ  λ©”μ†λ“μ— λ€ν• μ •λ³΄κ°€ μ΅΄μ¬
        - methodμ μ •λ³΄λ¥Ό λ‹΄κ³  μμ
        - κ° μ»¨νΈλ΅¤λ¬μ— μ •μλ methodλ“¤μ args(λ§¤κ°λ³€μ)μ •λ³΄λ¥Ό λ‹΄κ³  μλ” 
        - ν¬μΈνΈ μ»·μ— ν•΄λ‹Ήν•λ” μ •λ³΄κ°€ JoinPointμ— μμ
    - joinPoint.proceed()
        - proceed() : λ©”μ†λ“ μ‹¤ν–‰
        - JoinPointλ¥Ό νΈμ¶ν•λ” λ©”μ†λ“λ¥Ό ν†µν•΄ resultμ— κ²°κ³Όλ¥Ό λ‹΄μ.
    ```java
    public Object query(ProceedingJoinPoint joinPoint) {

        //(1)μ΅°μΈν¬μΈνΈμ λ©”μ†λ“ μ¶”μ¶
        MethodSignature signature = (MethodSignature) joinPoint.getSignature();
        Method method = signature.getMethod();

        ...
    ```

### 3. λ©”μ†λ“μ—μ„ μ”μ† μ¶”μ¶
- μμ‹ : λ©”μ„λ“μ @Operationκ³Ό @getMapping μ¶”μ¶
- method.getAnnotation(annotationClass)
    - μ§€μ •λ μ ν•(annotationClass)μ— λ€ν• μ–΄λ…Έν…μ΄μ…μ„ λ°ν™ν•κ³  μ•„λ‹λ©΄ nullμ„ λ°ν™
    ```
    Operation operation = method.getAnnotation(Operation.class);
    >> 
    λ©”μ„λ“μ— μ μ©λ @Operation λ°ν™
    @Operation(summary = "νμ›μ„ μ΅°νν•©λ‹λ‹¤ π”")
    ```
### 4. getRequestAttributes
- νΈμ¶λ κ°’μ Request κ°’μ„ μ–»μ„ λ• μ‚¬μ©, μ—†μΌλ©΄ null λ°ν™
- currentRequestAttributesμ™€ λΉ„μ·ν•μ§€λ§ currentRequestAttributesλ” κ°’μ΄ μ—†μΌλ©΄ μμ™Έ 

