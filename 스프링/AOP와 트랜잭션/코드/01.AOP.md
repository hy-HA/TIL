
## ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€
- ìŠ¤í”„ë§ ì›¹ì´ ì„¤ì¹˜ë˜ì–´ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì¶”ê°€ë¨
## @EnableAspectAutoProxy ì¶”ê°€
- @SpringBootApplication ë˜ëŠ” @Configurationì„ ì‚¬ìš©í•œ í´ë˜ìŠ¤ì— @EnableAspectAutoProxyë¥¼ ì¶”ê°€í•˜ë©´ Spring AOPë¥¼ ì‚¬ìš©ì´ ê°€ëŠ¥
    ```java
    @EnableAspectJAutoProxy
    @SpringBootApplication
    public class TestApplication {

        public static void main(String[] args) {
            SpringApplication.run(TestApplication.class, args);
        }
    }

    ```

## í´ë˜ìŠ¤ì— @Aspect ì ìš©
- Aspect ì—­í• ì„ í•  í´ë˜ìŠ¤ë¥¼ ì„ ì–¸í•˜ê¸° ìœ„í•´ ì–´ë…¸í…Œì´ì…˜ ì„ ì–¸
    - Adviceë“¤ + Pointcutë“¤
    - @Aspectê°€ ë“±ë¡ëœ ë¹ˆì—ëŠ” ì–´ë“œë°”ì´ìŠ¤(Advice)ë¼ ë¶ˆë¦¬ëŠ” ë©”ì„œë“œë¥¼ ì‘ì„± ê°€ëŠ¥
    ```java
    @Aspect
    @Component
    public class RequestLoggingAspect {
    }
    ```
- @Aspect ì–´ë…¸í…Œì´ì…˜ì„ ì ìš©í•œ í´ë˜ìŠ¤ëŠ”  
    1. Aspect êµ¬í˜„ì„ ì œê³µ
        - í•´ë‹¹ í´ë˜ìŠ¤ì˜ ë©”ì„œë“œëŠ” Aspectê°€ ì œê³µí•  ê³µí†µ ê¸°ëŠ¥ì˜ êµ¬í˜„ì— í•´ë‹¹
    2. PointCutê³¼ Adviceë¥¼ ì„¤ì •
        - ìœ„ ê³µí†µ ê¸°ëŠ¥ì„ ì–¸ì œ, ì–´ë””ì— ì ìš©í• ì§€ ì—¬ë¶€ëŠ” ë©”ì„œë“œì— ë¶™ì€ @Around ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ì„¤ì •
        - @Aspectê°€ ë“±ë¡ëœ ë¹ˆì—ëŠ” ì–´ë“œë°”ì´ìŠ¤(Advice)ë¼ ë¶ˆë¦¬ëŠ” ë©”ì„œë“œë¥¼ ì‘ì„± ê°€ëŠ¥
        - ëŒ€ìƒ ìŠ¤í”„ë§ ë¹ˆì˜ methodì˜ ì‹œì ê³¼ ë°©ë²•ì— ë”°ë¼ @Before, @After, @AfterReturning, @AfterThrowing, @Around ë“±ì„ ëª…ì‹œ
- ì¡°ê±´
    - ìŠ¤í”„ë§ ë¹ˆì— ë“±ë¡ëœ í´ë˜ìŠ¤ì— ì¶”ê°€
    - í•´ë‹¹ ë¹ˆì´ Aspectë¡œ ì‘ë™
- ì°¸ê³  
    - ë¹ˆ ê°„ ì‘ë™ìˆœì„œ ì ìš© ê°€ëŠ¥
        - í´ë˜ìŠ¤ì— @Orderë¥¼ ëª…ì‹œí•˜ì—¬ @Aspectë¡œ ë“±ë¡ëœ ë¹ˆ ê°„ì˜ ì‘ë™ ìˆœì„œë¥¼ ì •í•  ìˆ˜ ìˆìŒ
        - ìˆœì„œëŠ” int íƒ€ì…ì˜ ì •ìˆ˜ë¡œ ìˆœì„œë¥¼ ì •í•  ìˆ˜ ìˆëŠ”ë° ê°’ì´ ë‚®ì„ìˆ˜ë¡ ìš°ì„ ìˆœìœ„ê°€ ë†’ìŒ.
        - ìˆœì„œì˜ ê¸°ë³¸ê°’ì€ ê°€ì¥ ë‚®ì€ ìš°ì„ ìˆœìœ„ë¥¼ ê°€ì§€ëŠ” Ordered.LOWEST_PRECEDENCE
## PointCutê³¼ Advice ì„¤ì •
1. Pointcut
    - ì¡°ì¸ í¬ì¸íŠ¸ë¥¼ ê²°ì • ?
    - ì–´ë“œë°”ì´ìŠ¤ê°€ ì‹¤í–‰ë˜ëŠ” ì‹œê¸°ë¥¼ ì œì–´ ?
    - ì–´ë–¤ ë©”ì„œë“œë¥¼ ì¡ì„ì§€ ?
    - ì–´ë–¤ ì¡°ê±´ì— ì–´ë“œë°”ì´ìŠ¤ë¥¼ ì ìš©í•  ê²ƒì¸ê°€?
        - post, patch, put, delete ë“± 
    - ì†ì„±
        1. @within : í´ë˜ìŠ¤
        2. @annotation : ë©”ì†Œë“œ
    - ì˜ˆì‹œ : PostMapping ì–´ë…¸í…Œì´ì…˜ì´ ì‚¬ìš©ëœ ë©”ì„œë“œì— Advie ì ìš©
        ```java
        //PostMapping ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš©ëœ ë©”ì„œë“œ
        @Pointcut("@annotation(org.springframework.web.bind.annotation.PostMapping)")
        protected void PostMapping(){}

        //RestController ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš©ëœ í´ë˜ìŠ¤
        @Pointcut("@within(org.springframework.web.bind.annotation.RestController)")
        protected void restController() {}
        ```
2. Advice
    - í¬ì¸íŠ¸ì»·ì´ ì¡ì€ í´ë˜ìŠ¤ or ë©”ì„œë“œ
    ```java
    @Around(value = "restController() && getMapping()")
    public Object endpoint(ProceedingJoinPoint joinPoint) { }
    ```

    1. @Before
        - ëŒ€ìƒ method ì‹¤í–‰ "ì „"ì— ì›í•˜ëŠ” ì‘ì—…ì„ ì„¤ì •
        - í¬ì¸íŠ¸ì»·ê³¼ í•¨ê»˜ 
            - ì–´ë“œë°”ì´ìŠ¤ì˜ parameterëŠ” PointCut í‘œí˜„ì‹       
        - ë¼ì–´ë“¤ ë©”ì„œë“œì˜ ë²”ìœ„ë¥¼ ì§€ì •
            - ë¼ì–´ë“¤ê¸°ë§Œ í•  ë¿ ëŒ€ìƒ ë©”ì„œë“œì˜ ì œì–´ë‚˜ ê°€ê³µì€ ë¶ˆê°€ëŠ¥ 
        - ì „ë‹¬ ë°›ëŠ” JoinPoint ì˜¤ë¸Œì íŠ¸ëŠ” methodì˜ ì •ë³´ë¥¼ ë‹´ê³  ìˆìŒ
        ```java
        @Before("execution(* com.example.*.*(..))")
        public void somethingBefore(JoinPoint joinPoint) {
        }
        ```
    2. @AfterReturning
        - í•´ë‹¹ methodì˜ ì‹¤í–‰ì´ "ì¢…ë£Œë˜ì–´ ê°’ì„ ë¦¬í„´í•  ë•Œ"
            ```java
            @AfterReturning(pointcut = "execution(* com.example.*.*(..))", returning = "result")
            public void doSomethingAfterReturning(JoinPoint joinPoint, Object result) {
                // ë¦¬í„´ ì‹œ ì‹¤í–‰
            }
            ```

    3. @Around
    - @Around ì–´ë“œë°”ì´ìŠ¤ëŠ” @Before @After ê¸°ëŠ¥ì„ ëª¨ë‘ í¬ê´„
    - ëŒ€ìƒ methodë¥¼ ì‹¤í–‰ ì•/ë’¤ ì‹œì ì— ì›í•˜ëŠ” ì‘ì—… ì„¤ì • ê°€ëŠ¥
        ```java
        // íŠ¹ì • ì–´ë…¸í…Œì´ì…˜ì´ ëª…ì‹œëœ ëª¨ë“  ë©”ì„œë“œ ì‹¤í–‰ ì „í›„ë¡œ ë¼ì–´ë“¤ ìˆ˜ ìˆë‹¤.
        @Around("@annotation(sampleAnnotation)")
        public Object somethingAround(final ProceedingJoinPoint joinPoint, final SomeAnnotation someAnnotation) {

            // ì‹¤í–‰ ì „
            Object result = joinPoint.proceed();
            // ì‹¤í–‰ í›„

            return result;
        }

        // íŠ¹ì • ì–´ë…¸í…Œì´ì…˜ì´ ëª…ì‹œëœ í´ë˜ìŠ¤ì˜ ëª¨ë“  method
        @Around("@within(org.springframework.web.bind.annotation.RestController) || @within(org.springframework.stereotype.Service) || @within(org.springframework.stereotype.Repository)")
        public Object process(final ProceedingJoinPoint joinPoint) throws Throwable {
        }
        ```

## ë©”ì„œë“œì— ì‚¬ìš©ëœ ê°ì²´ë“¤

### 1. ì¡°ì¸í¬ì¸íŠ¸ì˜ ë©”ì„œë“œ ì¶”ì¶œ
1. MethodSignature
2. ì¡°ì¸í¬ì¸íŠ¸(ProceedingJoinPoint)
    - JoinPoint 
        - í˜¸ì¶œë˜ëŠ” ê°ì²´ì— ëŒ€í•œ ì •ë³´, ì‹¤í–‰ë  ë©”ì†Œë“œì— ëŒ€í•œ ì •ë³´ê°€ ì¡´ì¬
        - methodì˜ ì •ë³´ë¥¼ ë‹´ê³  ìˆìŒ
        - ê° ì»¨íŠ¸ë¡¤ëŸ¬ì— ì •ì˜ëœ methodë“¤ì˜ args(ë§¤ê°œë³€ìˆ˜)ì •ë³´ë¥¼ ë‹´ê³  ìˆëŠ” 
        - í¬ì¸íŠ¸ ì»·ì— í•´ë‹¹í•˜ëŠ” ì •ë³´ê°€ JoinPointì— ìˆìŒ
    - joinPoint.proceed()
        - proceed() : ë©”ì†Œë“œ ì‹¤í–‰
        - JoinPointë¥¼ í˜¸ì¶œí•˜ëŠ” ë©”ì†Œë“œë¥¼ í†µí•´ resultì— ê²°ê³¼ë¥¼ ë‹´ìŒ.
    ```java
    public Object query(ProceedingJoinPoint joinPoint) {

        //(1)ì¡°ì¸í¬ì¸íŠ¸ì˜ ë©”ì†Œë“œ ì¶”ì¶œ
        MethodSignature signature = (MethodSignature) joinPoint.getSignature();
        Method method = signature.getMethod();

        ...
    ```

### 3. ë©”ì†Œë“œì—ì„œ ìš”ì†Œ ì¶”ì¶œ
- ì˜ˆì‹œ : ë©”ì„œë“œì˜ @Operationê³¼ @getMapping ì¶”ì¶œ
- method.getAnnotation(annotationClass)
    - ì§€ì •ëœ ìœ í˜•(annotationClass)ì— ëŒ€í•œ ì–´ë…¸í…Œì´ì…˜ì„ ë°˜í™˜í•˜ê³  ì•„ë‹ˆë©´ nullì„ ë°˜í™˜
    ```
    Operation operation = method.getAnnotation(Operation.class);
    >> 
    ë©”ì„œë“œì— ì ìš©ëœ @Operation ë°˜í™˜
    @Operation(summary = "íšŒì›ì„ ì¡°íšŒí•©ë‹ˆë‹¤ ğŸ”")
    ```
### 4. getRequestAttributes
- í˜¸ì¶œëœ ê°’ì˜ Request ê°’ì„ ì–»ì„ ë•Œ ì‚¬ìš©, ì—†ìœ¼ë©´ null ë°˜í™˜
- currentRequestAttributesì™€ ë¹„ìŠ·í•˜ì§€ë§Œ currentRequestAttributesëŠ” ê°’ì´ ì—†ìœ¼ë©´ ì˜ˆì™¸ 

## ì „ì²´ íë¦„
1. ì¡°ì¸í¬ì¸íŠ¸ì˜ ë©”ì†Œë“œ ì¶”ì¶œ
2. ë©”ì†Œë“œì˜ ì˜¤í¼ë ˆì´ì…˜ê³¼ getMappingì–´ë…¸í…Œì´ì…˜ ì¶”ì¶œ
3. ì»¨íŠ¸ë¡¤ëŸ¬ì™€ ë©”ì†Œë“œì˜ ì´ë¦„, ë°˜í™˜ ê°’ì˜ ë¡œê·¸ ì¶œë ¥
4. ë©”ì†Œë“œ ì‹¤í–‰
```java
@Slf4j
@Aspect @Component
public class RequestLoggingAspect {

    @Around(value = "restController() && getMapping()")
    public Object query(ProceedingJoinPoint joinPoint) {

        //(1)ì¡°ì¸í¬ì¸íŠ¸ì˜ ë©”ì†Œë“œ ì¶”ì¶œ
        MethodSignature signature = (MethodSignature) joinPoint.getSignature();
        Method method = signature.getMethod();

        //(2) ë©”ì†Œë“œì˜ ì˜¤í¼ë ˆì´ì…˜ê³¼ getMappingì–´ë…¸í…Œì´ì…˜ ì¶”ì¶œ
        Operation operation = method.getAnnotation(Operation.class);
        GetMapping getMapping = method.getAnnotation(GetMapping.class);

        Object result;

        //(3) ì»¨íŠ¸ë¡¤ëŸ¬ì™€ ë©”ì†Œë“œì˜ ì´ë¦„, ë°˜í™˜ ê°’ì˜ ë¡œê·¸ ì¶œë ¥
        //(4) ë©”ì†Œë“œ ì‹¤í–‰
        try {
            log.error(operation.summary());
            log.error(Arrays.toString(getMapping.value()));
            result = joinPoint.proceed();
        } catch (Throwable e) {
            throw new RuntimeException(e);
        }

        return result;
    }

    @Pointcut("@annotation(org.springframework.web.bind.annotation.GetMapping)")
    protected void getMapping() {
    }

    @Pointcut("@within(org.springframework.web.bind.annotation.RestController)")
    protected void restController() {
    }
}
```