# soft delete μ™€ hard delete

# hard delete
```
@Transactional
public void deleteStudent(Long id) {

    studentRepository.deleteById(id);     

}
```

# soft delete 
- λ„λ©”μΈμ—μ„ delete μ»¬λΌ μ„¤μ •
## 1. ν™•μ¥λ°›μ„ BaseEntity μƒμ„± 
- BaseEntity μ–΄λ…Έν…μ΄μ…
    1. @Getter
    2. @MappedSuperclass 
    3. @EntityListeners(AuditingEntityListener.class) π¨
    [κ°λ…μ •λ¦¬](https://hackmd.io/YpHn8z9xQOiqfyUK226_eQ)
```
@Getter
@MappedSuperclass
@EntityListeners(AuditingEntityListener.class)
public class BaseEntity {

    @CreatedDate
    private LocalDateTime createdDate;

    @LastModifiedDate
    private LocalDateTime modifiedDate;

    //π§©μƒμ†λ°›λ” ν΄λμ¤λ“¤μ΄ μ‚¬μ©ν•λ ¤λ©΄? 
    //protectedκ°€ μµμ„ ? privateλ”? publicμ€?
    protected Boolean isDeleted;

    public void delete() {
        this.isDeleted = true;
    }

}
```
## 2. ν™•μ¥ν•λ” Student λ„λ©”μΈμ—μ„ where μ–΄λ…Έν…μ΄μ… μ‚¬μ©
### @Where(clause = "is_deleted = false")
- μ—­ν•  π¨
    - BaseEntityμ—μ„ μ •μν• delete()λ©”μ†λ“λ¥Ό ν™•μ¥ν•λ”λ„λ©”μΈ.delete()λ΅ μ‚¬μ©κ°€λ¥ν•κ² ν•¨. 
```
@Getter
@NoArgsConstructor
@Entity
@Table(name="student")
@Where(clause = "is_deleted = false")
// @SQLDelete(sql = "update student set is_deleted = true where student_id = ?")
public class Student extends BaseEntity {

    @Id @GeneratedValue
    @Column(name = "student_id")
    private Long id;

    private String name;

    private int score;

    @Builder
    public Student(String name, int score){
        this.name = name;
        this.score = score;
        this.isDeleted = false;
    }
```

## 3. μ„λΉ„μ¤μ—μ„ μ‚­μ κΈ°λ¥ μ‚¬μ©
- μµμ…”λ„μ μμ™Έμ²λ¦¬ 
```
@Transactional
public void deleteStudent(Long id) {
    
    //(1) hard delete
    studentRepository.deleteById(id);     

    //(2) soft delete
    Student student = studentRepository.findById(id)
                .orElseThrow(() -> DomainException.notFoundRow(id));
    student.delete();   
}
```

## 4. μ»¨νΈλ΅¤λ¬μ—μ„ μ„¤μ •
### μ»¨νΈλ΅¤λ¬μ νΉμ§•
1. νλΌλ―Έν„°μ— μ–΄λ…Έν…μ΄μ…μ„ λ¶™μ—¬μ•Ό
    - @RequestBody
    - @PathVariable
2. μ£Όμ†λ¥Ό μ•λ ¤μ¤μ•Ό 
    - @PatchMapping("/grade/{id}/score)
3. μ»¨νΈλ΅¤λ¬ μ—λ…Έν…μ΄μ…
    - @ResponseBody
    - @RequiredArgsConstructor
    - @RequestMapping("/student")
### @PathVariable
- μ‚­μ μ κ²½μ° νλΌλ―Έν„°λ΅ idκ°’μ„ λ°›μΌλ―€λ΅ @RequestBodyκ°€ μ•„λ‹λΌ @PathVariable
```
@ResponseBody
    @DeleteMapping("/{id}")
    public ResponseEntity<StudentResponse> deleteStudent(@PathVariable Long id) {
        studentService.deleteStudent(id);
        return ResponseEntity.status(HttpStatus.NO_CONTENT).build();
    }
```

## @MappedSuperclass
- κ°μ²΄μ μ…μ¥μ—μ„ κ³µν†µ λ§¤ν•‘μ •λ³΄κ°€ ν•„μ”ν•  λ• μ‚¬μ©
- @MappedSuperclassκ°€ μ„ μ–Έλμ–΄ μλ” ν΄λμ¤λ” μ—”ν‹°ν‹°κ°€ μ•„λ‹λ‹¤. 
    - λ‹Ήμ—°ν ν…μ΄λΈ”κ³Ό λ§¤ν•‘λ„ μ•λλ‹¤. 
    - λ‹¨μν λ¶€λ¨ ν΄λμ¤λ¥Ό μƒμ† λ°›λ” μμ‹ ν΄λμ¤μ— λ§¤ν•‘ μ •λ³΄λ§ μ κ³µν•λ‹¤.
- μ§μ ‘ μƒμ„±ν•΄μ„ μ‚¬μ©ν•  μΌμ΄ μ—†μΌλ―€λ΅ μ¶”μƒ ν΄λμ¤λ΅ λ§λ“λ” κ²ƒμ„ κ¶μ¥ν•¨
- ν•΄λ‹Ή μ–΄λ…Έν…μ΄μ…μ΄ λ¶™μ€ ν΄λμ¤λ” λ¨λ“  Entityμ μƒμ„ ν΄λμ¤κ°€ λ¨
    - Entity λ“¤μ createdDate, modifiedDateλ¥Ό μλ™μΌλ΅ κ΄€λ¦¬ν•λ” μ—­ν• 
- @MappedSuperclass 
    - JPA Entity ν΄λμ¤λ“¤μ΄ ν•΄λ‹Ή ν΄λμ¤λ¥Ό μƒμ†ν•  κ²½μ° ν•„λ“λ“¤(createdDate, modifiedDate)λ„ μΉΌλΌμΌλ΅ μΈμ‹ν•λ„λ΅ ν•¨
- @EntityListeners(AuditingEntityListener.class)
    - BaseTimeEntiy ν΄λμ¤μ— Auditing κΈ°λ¥μ„ ν¬ν•¨μ‹ν‚µλ‹λ‹¤.
- @CreatedDate
    - Entityκ°€ μƒμ„±λμ–΄ μ €μ¥λ  λ• μ‹κ°„μ΄ μλ™ μ €μ¥λ©λ‹λ‹¤.
- @LastModifiedDate
    - μ΅°νν• Entityμ κ°’μ„ λ³€κ²½ν•  λ• μ‹κ°„μ΄ μλ™ μ €μ¥λ©λ‹λ‹¤.

```java
@Getter
@MappedSuperclass
@EntityListeners(AuditingEntityListener.class)
public abstract class BaseTimeEntity {

    @CreatedDate
    private LocalDateTime createdDate;

    @LastModifiedDate
    private LocalDateTime modifiedDate;

}
```
## Application ν΄λμ¤
- JPA Auditing μ–΄λ…Έν…μ΄μ…λ“¤μ„ λ¨λ‘ ν™μ„±ν™”ν•  μ μλ„λ΅ Application ν΄λμ¤μ— ν™μ„±ν™” μ–΄λ…Έν…μ΄μ…μ„ μ¶”κ°€ν•©λ‹λ‹¤.
- @EnableJpaAuditing: JPA Auditingμ„ ν™μ„±ν™” ν•κΈ° μ„ν• μ–΄λ…Έν…μ΄μ…μ…λ‹λ‹¤.
```java
@EnableJpaAuditing
@SpringBootApplication
public class Application {

    public static void main(String[] args) {
        SpringApplication.run(CaffeineApplication.class, args);
    }
}
```
