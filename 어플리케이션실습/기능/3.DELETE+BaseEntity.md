# soft delete μ™€ hard delete

# hard delete
```
@Transactional
public void deleteStudent(Long id) {

    studentRepository.deleteById(id);     

}
```

# soft delete 
- λ„λ©”μΈμ—μ„ delete μ»¬λΌ μ„¤μ •

## 1. μƒμ†ν•  BaseEntity μƒμ„± 
- BaseEntity μ–΄λ…Έν…μ΄μ…
    1. @Getter
    2. @MappedSuperclass 
        - κ°μ²΄μ μ…μ¥μ—μ„ κ³µν†µ λ§¤ν•‘μ •λ³΄κ°€ ν•„μ”ν•  λ• μ‚¬μ©
        - λ” μμ„Έν• λ¶€λ¶„μ€ μ•„λμ—μ„ μ„¤λ…
    3. @EntityListeners(AuditingEntityListener.class)
        - BaseEntiy ν΄λμ¤μ— Auditing κΈ°λ¥μ„ ν¬ν•¨

```
@Getter
@MappedSuperclass
@EntityListeners(AuditingEntityListener.class)
public class BaseEntity {

    @CreatedDate
    private LocalDateTime createdDate;

    @LastModifiedDate
    private LocalDateTime modifiedDate;

    //π§©μƒμ†λ°›λ” ν΄λμ¤λ“¤μ΄ μ‚¬μ©ν•λ ¤λ©΄? 
    //protectedκ°€ μµμ„ ? 
    protected Boolean isDeleted;

    public void delete() {
        this.isDeleted = true;
    }

}
```
## 2. μƒμ†λ°›λ” λ„λ©”μΈμ— μ‚¬μ©λλ” μ–΄λ…Έν…μ΄μ…

### @Where(clause = "is_deleted = false")
- JPAμ—μ„ @Whereλ¥Ό μ‚¬μ©ν•λ©΄ μ—”ν‹°ν‹°λ¥Ό μ΅°νν•λ” κ²½μ° μΌκ΄„μ μΈ Where μ΅°κ±΄μ„ μ¶”κ°€ν•  μ 
    - @Where(clause = "{DB μ»¬λΌλ…} μ΅°κ±΄")
- BaseEntityμ—μ„ μ •μν• delete()λ©”μ†λ“λ¥Ό ν™•μ¥ν•λ”λ„λ©”μΈ.delete()λ΅ μ‚¬μ©κ°€λ¥ν•κ² ν•¨. 
- μ°Έκ³  : JPQL

```java
@Getter
@NoArgsConstructor
@Entity
@Table(name="student")
@Where(clause = "is_deleted = false")
// @SQLDelete(sql = "update student set is_deleted = true where student_id = ?")
public class Student extends BaseEntity {

    @Id @GeneratedValue
    @Column(name = "student_id")
    private Long id;

    private String name;

    private int score;

    @Builder
    public Student(String name, int score){
        this.name = name;
        this.score = score;
        this.isDeleted = false;
    }
```

```java
@Getter
@MappedSuperclass
@EntityListeners(AuditingEntityListener.class)
public abstract class BaseTimeEntity {

    @CreatedDate
    private LocalDateTime createdDate;

    @LastModifiedDate
    private LocalDateTime modifiedDate;

}
```
## 4. μ„λΉ„μ¤μ—μ„ μ‚­μ κΈ°λ¥ μ‚¬μ©
- μµμ…”λ„μ μμ™Έμ²λ¦¬ 
```
@Transactional
public void deleteStudent(Long id) {
    
    //(1) hard delete
    studentRepository.deleteById(id);     

    //(2) soft delete
    Student student = studentRepository.findById(id)
                .orElseThrow(() -> DomainException.notFoundRow(id));
    student.delete();   
}
```

## 5. μ»¨νΈλ΅¤λ¬μ—μ„ μ„¤μ •
### μ»¨νΈλ΅¤λ¬μ νΉμ§•
1. νλΌλ―Έν„°μ— μ–΄λ…Έν…μ΄μ…μ„ λ¶™μ—¬μ•Ό
    - @RequestBody
    - @PathVariable
2. μ£Όμ†λ¥Ό μ•λ ¤μ¤μ•Ό 
    - @PatchMapping("/grade/{id}/score)
3. μ»¨νΈλ΅¤λ¬ μ—λ…Έν…μ΄μ…
    - @ResponseBody
    - @RequiredArgsConstructor
    - @RequestMapping("/student")
### @PathVariable
- μ‚­μ μ κ²½μ° νλΌλ―Έν„°λ΅ idκ°’μ„ λ°›μΌλ―€λ΅ @RequestBodyκ°€ μ•„λ‹λΌ @PathVariable
```
@ResponseBody
    @DeleteMapping("/{id}")
    public ResponseEntity<StudentResponse> deleteStudent(@PathVariable Long id) {
        studentService.deleteStudent(id);
        return ResponseEntity.status(HttpStatus.NO_CONTENT).build();
    }
```

## 6. Application ν΄λμ¤
- JPA Auditing μ–΄λ…Έν…μ΄μ…λ“¤μ„ λ¨λ‘ ν™μ„±ν™”ν•  μ μλ„λ΅ Application ν΄λμ¤μ— ν™μ„±ν™” μ–΄λ…Έν…μ΄μ…μ„ μ¶”κ°€ν•©λ‹λ‹¤.
- @EnableJpaAuditing: JPA Auditingμ„ ν™μ„±ν™” ν•κΈ° μ„ν• μ–΄λ…Έν…μ΄μ…μ…λ‹λ‹¤.
```java
@EnableJpaAuditing
@SpringBootApplication
public class Application {

    public static void main(String[] args) {
        SpringApplication.run(CaffeineApplication.class, args);
    }
}
```

---

## @MappedSuperclass
- [μ°Έκ³ ](https://ict-nroo.tistory.com/129)

## μ–Έμ  μ‚¬μ©?
- κ°μ²΄μ μ…μ¥μ—μ„ `κ³µν†µ λ§¤ν•‘ μ •λ³΄`κ°€ ν•„μ”ν•  λ• 
    - id, nameμ€ κ°μ²΄μ μ…μ¥μ—μ„ λ³Ό λ• κ³„μ† λ‚μ¨λ‹¤.
- `κ³µν†µ λ§¤ν•‘ μ •λ³΄`λ¥Ό λ¶€λ¨ ν΄λμ¤μ— μ„ μ–Έν•κ³  μ†μ„±λ§ μƒμ† λ°›μ•„μ„ μ‚¬μ©ν•κ³  μ‹¶μ„ λ• 
- DB ν…μ΄λΈ”κ³Όλ” μƒκ΄€μ—†λ‹¤. μ•„λμ— λ³΄λ©΄ DBλ” λ§¤ν•‘ μ •λ³΄ λ‹¤ λ”°λ΅ μ“°κ³  μλ‹¤. κ°μ²΄μ μ…μ¥μ΄λ‹¤.
![](https://i.imgur.com/IN4zVNn.png)
- νΉμ§•
    - DBμ™€μ κ΄€κ³„ : μ—”ν‹°ν‹°κ°€ μ•„λ‹
        - @MappedSuperclassκ°€ μ„ μ–Έλμ–΄ μλ” ν΄λμ¤λ” μ—”ν‹°ν‹°κ°€ μ•„λ‹λ‹¤. 
        - λ‹Ήμ—°ν ν…μ΄λΈ”κ³Ό λ§¤ν•‘λ„ μ•λλ‹¤. 
        - λ‹¨μν λ¶€λ¨ ν΄λμ¤λ¥Ό μƒμ† λ°›λ” μμ‹ ν΄λμ¤μ— λ§¤ν•‘ μ •λ³΄λ§ μ κ³µν•λ‹¤.
    - μ§μ ‘ μƒμ„±ν•΄μ„ μ‚¬μ©ν•  μΌμ΄ μ—†μΌλ―€λ΅ μ¶”μƒ ν΄λμ¤λ΅ λ§λ“λ” κ²ƒμ„ κ¶μ¥ν•¨
    - ν•΄λ‹Ή μ–΄λ…Έν…μ΄μ…μ΄ λ¶™μ€ ν΄λμ¤λ” λ¨λ“  Entityμ μƒμ„ ν΄λμ¤κ°€ λ¨
        - Entity λ“¤μ createdDate, modifiedDateλ¥Ό μλ™μΌλ΅ κ΄€λ¦¬ν•λ” μ—­ν• 
    - JPA Entity ν΄λμ¤λ“¤μ΄ ν•΄λ‹Ή ν΄λμ¤λ¥Ό μƒμ†ν•  κ²½μ° ν•„λ“λ“¤(createdDate, modifiedDate)λ„ μΉΌλΌμΌλ΅ μΈμ‹ν•λ„λ΅ ν•¨
    - κ³µν†µν•„λ“ μμ‹
        - @CreatedDate
            - Entityκ°€ μƒμ„±λμ–΄ μ €μ¥λ  λ• μ‹κ°„μ΄ μλ™ μ €μ¥λ©λ‹λ‹¤.
        - @LastModifiedDate
            - μ΅°νν• Entityμ κ°’μ„ λ³€κ²½ν•  λ• μ‹κ°„μ΄ μλ™ μ €μ¥λ©λ‹λ‹¤.

## μ‚¬μ©λ²•
1. κ³µν†µμΌλ΅ μ‚¬μ©ν•  ν•„λ“λ¥Ό μ„ μ–Έν•λ” BaseEntity μ¶”μƒν΄λμ¤ μ„ μ–Έ
    - μ§μ ‘ μƒμ„±ν•΄μ„ μ‚¬μ©ν•μ§€ μ•μΌλ―€λ΅ μ¶”μƒν΄λμ¤λ΅ μ„ μ–Έ
    - ν•„μ”μ‹ λ©”μ†λ“λ„ μ„ μ–Έ
2. μμ‹ ν΄λμ¤μ—μ„ μƒμ†
    - @MappedSuperclass μ–΄λ…Έν…μ΄μ… μ‚¬μ©
3. μ‹¤ν–‰λ DDL ν™•μΈ
    - μμ‹ μ—”ν‹°ν‹° ν…μ΄λΈ”μ΄ μƒκΈΈ λ• BaseEntityμ— μ„ μ–Έλ μ»¬λΌλ“¤μ΄ μƒμ„± λλ‹¤.
## μ •λ¦¬
- μƒμ†κ΄€κ³„ λ§¤ν•‘μ΄ μ•„λ‹λ‹¤.
- @MappedSuperclassκ°€ μ„ μ–Έλμ–΄ μλ” ν΄λμ¤λ” μ—”ν‹°ν‹°κ°€ μ•„λ‹. λ‹Ήμ—°ν ν…μ΄λΈ”κ³Ό λ§¤ν•‘λ„ μ•λλ‹¤.
- λ‹¨μν μμ‹ ν΄λμ¤μ— λ§¤ν•‘ μ •λ³΄λ§ μ κ³µ
- μ΅°ν, κ²€μƒ‰μ΄ λ¶κ°€ν•λ‹¤. 
    - λ¶€λ¨ νƒ€μ…μΌλ΅ μ΅°νν•λ” κ²ƒμ΄ λ¶κ°€λ¥ν•λ‹¤λ” μ΄μ•ΌκΈ°.(em.find(BaseEntity) λ¶κ°€λ¥)
- μ§μ ‘ μƒμ„±ν•΄μ„ μ‚¬μ©ν•  μΌμ΄ μ—†μΌλ―€λ΅ μ¶”μƒ ν΄λμ¤λ΅ λ§λ“λ” κ²ƒμ„ κ¶μ¥ν•λ‹¤.
- ν…μ΄λΈ”κ³Ό κ΄€κ³„κ°€ μ—†κ³ , λ‹¨μν μ—”ν‹°ν‹°κ°€ κ³µν†µμΌλ΅ μ‚¬μ©ν•λ” λ§¤ν•‘ μ •λ³΄λ¥Ό λ¨μΌλ” μ—­ν• μ„ ν•λ‹¤.
- μ£Όλ΅ λ“±λ΅μΌ, μμ •μΌ, λ“±λ΅μ, μμ •μ κ°™μ€ μ „μ²΄ μ—”ν‹°ν‹°μ—μ„ κ³µν†µμΌλ΅ μ μ©ν•λ” μ •λ³΄λ¥Ό λ¨μ„ λ• μ‚¬μ©
### μ°Έκ³ 
- JPAμ—μ„ @Entity ν΄λμ¤λ” @Entityλ‚ @MappedSuperclassλ΅ μ§€μ •ν• ν΄λμ¤λ§ μƒμ†ν•  μ μλ‹¤.


# @EntityListeners(AuditingEntityListener.class)

## JPA EntityListeners λ€?
- JPA Entityμ— μ΄λ²¤νΈκ°€ λ°μƒν•  λ• μ½λ°±μ„ μ²λ¦¬ν•κ³  μ½”λ“λ¥Ό μ‹¤ν–‰ν•λ” λ°©λ²•
### EntityListenersκ°€ μ κ³µν•λ” λ©”μ†λ“
- EntityListenersλ” JPA Entityμ— Persist, Remove, Update, Loadμ— λ€ν• event μ „κ³Ό ν›„μ— λ€ν• μ½λ°± λ©”μ„λ“λ¥Ό μ κ³µν•λ‹¤.
![](https://i.imgur.com/ueD8lc1.png)