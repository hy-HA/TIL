# soft delete 와 hard delete

# hard delete
```
@Transactional
public void deleteStudent(Long id) {

    studentRepository.deleteById(id);     

}
```

# soft delete 
- 도메인에서 delete 컬럼 설정
## 1. 확장받을 BaseEntity 생성 
- BaseEntity 어노테이션
    1. @Getter
    2. @MappedSuperclass 
    3. @EntityListeners(AuditingEntityListener.class) 🟨
    [개념정리](https://hackmd.io/YpHn8z9xQOiqfyUK226_eQ)
```
@Getter
@MappedSuperclass
@EntityListeners(AuditingEntityListener.class)
public class BaseEntity {

    @CreatedDate
    private LocalDateTime createdDate;

    @LastModifiedDate
    private LocalDateTime modifiedDate;

    //🧩상속받는 클래스들이 사용하려면?
    protected Boolean isDeleted;

    public void delete() {
        this.isDeleted = true;
    }

}
```
## 2. 확장하는 Student 도메인에서 where 어노테이션 사용
### @Where(clause = "is_deleted = false")
- 역할 🟨
    - BaseEntity에서 정의한 delete()메소드를 확장하는도메인.delete()로 사용가능하게 함. 
```
@Getter
@NoArgsConstructor
@Entity
@Table(name="student")
@Where(clause = "is_deleted = false")
// @SQLDelete(sql = "update student set is_deleted = true where student_id = ?")
public class Student extends BaseEntity {

    @Id @GeneratedValue
    @Column(name = "student_id")
    private Long id;

    private String name;

    private int score;

    @Builder
    public Student(String name, int score){
        this.name = name;
        this.score = score;
        this.isDeleted = false;
    }
```

## 3. 서비스에서 삭제기능 사용
- 옵셔널의 예외처리 
    - [참고 : 프로그래밍의 오류와 예외](https://hackmd.io/GJc-8M34RhikhvlyUNiCoQ)
- `Optional.orElseThrow()`
```
@Transactional
public void deleteStudent(Long id) {
    
    //(1) hard delete
    studentRepository.deleteById(id);     

    //(2) soft delete
    Student student = studentRepository.findById(id)
                .orElseThrow(() -> DomainException.notFoundRow(id));
    student.delete();   
}
```

## 4. 컨트롤러에서 설정
### 컨트롤러의 특징
1. 파라미터에 어노테이션을 붙여야
    - @RequestBody
    - @PathVariable
2. 주소를 알려줘야 
    - @PatchMapping("/grade/{id}/score)
3. 컨트롤러 에노테이션
    - @ResponseBody
    - @RequiredArgsConstructor
    - @RequestMapping("/student")
### @PathVariable
- 삭제의 경우 파라미터로 id값을 받으므로 @RequestBody가 아니라 @PathVariable
```
@ResponseBody
    @DeleteMapping("/{id}")
    public ResponseEntity<StudentResponse> deleteStudent(@PathVariable Long id) {
        studentService.deleteStudent(id);
        return ResponseEntity.status(HttpStatus.NO_CONTENT).build();
    }
```
